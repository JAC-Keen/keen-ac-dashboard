<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Keen Auto-Collector Dashboard</title>
  <link rel="shortcut icon" href="https://keen.io/assets/images/favicon.ico"/>
  <!-- CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./assets/demo-styles.css" />
  <!-- JS -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-analysis@3"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/keen-dataviz@3/dist/keen-dataviz.min.js"></script>
  <!-- Keen Setttings -->
  <script src="./coordinates.js"></script>
  <script src="./settings.js"></script>
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.css' rel='stylesheet' />
  <script type="text/javascript" src="https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.js"></script>
</head>

<body class="demo-theme-dashboard" onload="settings()">



  <nav>
    <div class="container">
      <ul class="nav nav-tabs nav-links">
        <li class="nav-item"><a id="a-logo" class="nav-logo" href="./index.html"><img class="keen-logo" src="/img/logo.png"></a></li>
        <li class="nav-item tab tab-overview"><a id="a-overview" class="nav-link active" href="#">Overview</a></li>
        <li class="nav-item tab tab-views"><a id="a-views" class="nav-link" href="#">Views</a></li>
        <li class="nav-item tab tab-clicks"><a id="a-clicks" class="nav-link" href="#">Clicks</a></li>
      </ul>

      <ul class="nav nav-tabs nav-deploy-buttons">
        <li class="nav-item">
          <a class="nav-link" href="https://app.netlify.com/start/deploy?repository=https://github.com/keen/auto-collector-dashboard">
            <img src="https://www.netlify.com/img/deploy/button.svg" alt="Deploy to Netlify">
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container">

    <div class="mt-5 mb-4 w-100 d-flex">
      <h4 class="flex-fill mb-0">
        Keen - AutoCollector Dash - <span id="header-tab-name"></span>
      </h4>
      <div class="align-self-end text-black-50" id="current-datetime"></div>
    </div>




    <div id="tab-content-overview" class="hide tab-content">
        <div class="row">
          <div class="col-sm-3">
            <div
              id="chart-views-last-24h"
              class="chart-box chart-box-relative box-small">
          </div>
        </div>
        <div class="col-sm-3">
          <div
            id="chart-views-last-7d"
            class="chart-box chart-box-relative box-small">
        </div>
      </div>
      <div class="col-sm-3">
        <div
          id="chart-clicks-last-24h"
          class="chart-box chart-box-relative box-small">
        </div>
      </div>
      <div class="col-sm-3">
        <div
          id="chart-clicks-last-7d"
          class="chart-box chart-box-relative box-small">
        </div>
      </div>
    </div>

    <div class="row d-flex">
      <div class="col-sm-12 d-flex">
        <div class="chart-box views-box">
          <div class="chart-top-referrers chart"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-3 d-flex">
        <div class="chart-box">
          <div class="metric-box" id="unique-users-this-7d">
          </div>
        </div>
      </div>
      <div class="col-sm-3 d-flex">
        <div class="chart-box">
          <div class="metric-box" id="average-time-on-page">
          </div>
        </div>
      </div>
      <div class="col-sm-3 d-flex">
        <div class="chart-box">
          <div class="metric-box" id="average-clicks-per-user">
          </div>
        </div>
      </div>
      <div class="col-sm-3 d-flex">
        <div class="chart-box">
          <div class="metric-box" id="average-scroll-ratio">
          </div>
        </div>
      </div>

    </div>

    <div class="row">
      <div class="col-sm-12 chart-box-top">
        <div class="map-label">Visitor locations</div>
        <div id="map" class="map"></div>
      </div>
    </div>

    </div>







<div id="tab-content-views" class="hide tab-content">

<div class="row">
      <div class="col-sm-12">
        <div
          id="chart-views-uniques-7d"
          class="chart-box chart-box-relative">
      </div>
    </div>
</div>

<div class="row">
    <div class=" col-sm-6">
      <div class="chart chart-box chart-count-views-by-page"></div>
    </div>
    <div class=" col-sm-6">
      <div class="chart chart-box chart-table chart-pageviews-by-referrer"></div>
    </div>
</div>

<div class="row">
    <div class=" col-sm-4">
      <div class="chart chart-box chart-pageviews-by-day-of-week"></div>
    </div>
    <div class=" col-sm-8">
      <div class="chart chart-box chart-views-by-hour"></div>
    </div>
</div>

<div class="row">
    <div class="col-sm-6">
      <div class="chart chart-box chart-table chart-percent-of-page-read"></div>
    </div>
    <div class=" col-sm-6">
      <div class="chart chart-box chart-table chart-longest-time-on-page"></div>
    </div>
</div>


<div class="row">
<div class=" col-sm-12">
  <div class="chart chart-box chart-pageviews-by-country-interval-daily"></div>
</div>
</div>


<div class="row">
    <div class="col-sm-6">
      <div class="chart chart-box chart-pageviews-by-os"></div>
    </div>
    <div class="col-sm-6">
      <div class="chart chart-box chart-top-pages-screen-width"></div>
    </div>
</div>

</div>




<div id="tab-content-clicks" class="hide tab-content">

  <div class="row">
    <div class="col-sm-12">
    <div class="chart chart-box chart-clicks-explorer">
    </div>
    </div>
  </div>



    <div class="row">
      <div class="col-sm-6">
        <div class="chart chart-box chart-clicks-by-country">
          </div>
      </div>
      <div class="col-sm-6">
        <div class="chart chart-box chart-table chart-outbound-clicks">
        </div>
      </div>
    </div>

  <div class="row">
    <div class="col-sm-6">
    <div class=" chart chart-box chart-clicks-by-button-in-org-section">
    </div>
    </div>

    <div class="col-sm-6">
    <div class="chart chart-box chart-clicks-by-button-in-static-section">
    </div>
    </div>
  </div>


  <div class="row">
    <div class="col-sm-12">
    <div class="chart chart-box chart-clicks-by-country-daily">
    </div>
    </div>
  </div>


  <div class="row">
    <div class="col-sm-4">
    <div class="chart chart-box chart-clicks-login-google-github">
    </div>
    </div>
    <div class="col-sm-8">
    <div class="chart chart-box chart-clicks-api-docs-sdks-by-country">
    </div>
    </div>
  </div>

  <div class="row">

    <div class="col-sm-6">
    <div class="chart chart-box chart-clicks-by-html-tag">
    </div>
    </div>

    <div class="col-sm-6">
    <div class="chart chart-box chart-clicks-api-docs-sdks">
    </div>
    </div>

  </div>


</div>

</div>

</div>



<script>


let activeTab;

function jsUcfirst(string)
{
    return string.charAt(0).toUpperCase() + string.slice(1);
}

function switchTab(tabName){
  activeTab = tabName;
  const headerTab = document.querySelector('#header-tab-name');
  headerTab.innerHTML = jsUcfirst(tabName);
  const tabs = document.querySelectorAll('.nav-links .tab a');
  tabs.forEach(tab => {
    tab.classList.remove('active');
    tab.classList.add('text-black-50');
  });
  const tab = document.querySelector(`.nav-links .tab-${tabName} a`);
  tab.classList.add('active');
  tab.classList.remove('text-black-50');
  const tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(tab => {
    tab.classList.add('hide');
  });
  const tabContent = document.getElementById(`tab-content-${tabName}`);
  tabContent.classList.remove('hide');
  window.renderCharts();
}

const aLogo = document.getElementById('a-logo');
aLogo.addEventListener('click', (e) => {
  e.preventDefault();
  switchTab('overview');
});

const aOverview = document.getElementById('a-overview');
aOverview.addEventListener('click', (e) => {
  e.preventDefault();
  switchTab('overview');
});

const aViews = document.getElementById('a-views');
aViews.addEventListener('click', (e) => {
  e.preventDefault();
  switchTab('views');
});

const aClicks = document.getElementById('a-clicks');
aClicks.addEventListener('click', (e) => {
  e.preventDefault();
  switchTab('clicks');
});



/*

autocollector-dashboard-demo---count-pageviews-top-referrers-previous-7-days-interval-daily

autocollector-dashboard-demo---count-pageviews-by-browser-family

// avg time on site

autocollector-dashboard-demo---count-unique-pageviews
autocollector-dashboard-demo---count-unique-clicks


// PERCENT of users on mobile (gauge)
autocollector-dashboard-demo---count-pageviews-previous-24h
autocollector-dashboard-demo---count-pageviews-previous-24h-mobile

MAP
autocollector-dashboard-demo---count-pageviews-by-city

*/

const colors = ['#51a5de', '#76ddfb', '#5eadff', '#5e77ff', '#8698fc', '#6d83ff', '#5770ff', '#6d9aff'];

const pieColors = [
  '#5E77FF',
  '#9C60FE',
  '#F162FE',
  '#FD65B7',
  '#FD6768',
  '#FDB86A',
  '#F2FC6C',
  '#A5FC6E',
  '#71FB85',
  '#73FBD0',
  '#76DDFA',
  '#76f4fa',
  '#bb76fa',
  '#fa76bf'
];

const triadicColors = [
  '#5e77ff',
  '#ff5e77',
  '#77ff5e',
  '#ffe65e'
];

const barColors = [
  '#fed760',
  '#FD5E76',
  '#965eff',
  '#9bc77b',
  '#5e77ff',
  '#ffe65e',
  '#ff5e77',

];

function parseInto2DArray(result, columnKey, rowKey){
  const columns = [];
  const rows = [];
  const matrix = [];
  matrix.push(['Index']);
  const nulls = [];
  result.forEach(item => {
    let newColumn = item[columnKey];
    if (matrix[0].indexOf(newColumn) === -1) {
      matrix[0][matrix[0].length] = newColumn;
      nulls.push(null);
    }
  });

  result.forEach(item => {
    let newRow = item[rowKey];
    let rowIndex = matrix.findIndex(rowItem => rowItem[0] === newRow);
    if (rowIndex === -1) {
      matrix[matrix.length] = [newRow, ...nulls];
      rowIndex = matrix.length - 1;
    }
    let columnIndex = matrix[0].findIndex(rowItem => rowItem === item[columnKey]);
    matrix[rowIndex][columnIndex] = item.result;
  });

  return matrix;
}

const areaChartWithDetails = ({
  client,
  container,
  queries,
  title
}) => {
  const containerElement = document.getElementById(container);
  containerElement.innerHTML = `
  <div class="perecent-difference"></div>
  <div class="current-count"></div>
  <div class="chart"></div>`;

  client
  .query({
    saved_query_name: queries.current
  })
  .then(res => {
    const countPageviewsPrevious24h = res.result;
    client
    .query({
      saved_query_name: queries.compareWith
    })
    .then(res => {
      const countPageviewsPrevious24hDayAgo = res.result - countPageviewsPrevious24h;

      let percentDifference = Math.round(countPageviewsPrevious24h/countPageviewsPrevious24hDayAgo*100);
      if (percentDifference < 100) {
        percentDifference = (100 - percentDifference)*-1;
      }
      if (percentDifference > 100) {
        percentDifference -= 100;
      }

      const countLabel = containerElement.querySelector('.current-count');
      countLabel.innerHTML = countPageviewsPrevious24h;
      const percentLabel = containerElement.querySelector('.perecent-difference');
      let faDirection = 'up';
      if (percentDifference < 0){
        faDirection = 'down';
        percentLabel.classList.add('chart-inline-label-decreased', 'chart-inline-label-decreased-important');
        countLabel.classList.add('chart-inline-label-decreased');
      }
      if (percentDifference > 0){
        percentLabel.classList.add('chart-inline-label-increased');
        countLabel.classList.add('chart-inline-label-increased');
      }
      percentLabel.innerHTML = `<i class='fas fa-angle-${faDirection}'></i> ${percentDifference} %`;

    });
  });


  client
  .query({
    saved_query_name: queries.area
  })
  .then(res => {
    const chartRoot = containerElement.querySelector(".chart");
    const revenueChart = new KeenDataviz({
      container: chartRoot,
      title,
      results: res,
      type: 'area-spline',
      point: {
        r: 0,
        focus: {
          expand: {
            r: 5,
            enabled: true
          },
        },
        select: {
          r: 5,
          enabled: true
        }
      },
      axis: {
        y: {
          show: false
        },
        x: {
          show:false
        }
      },
      grid:{
        x: {
          show: false
        },
        y: {
          show: false
        }
      },
      colors: ['#5e77ff'],
      padding: {
        left: 0,
        right: 0
      },
    });
  });
};

window.initializeDashboard = function(client, timeframe) {

  window.renderCharts = () => {

  /*
    query: 'autocollector-dashboard-demo---top-pages-with-referral',
  */

if (activeTab === 'views') {
client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---pageviews-by-country-interval-daily'
  })
  .then(results => {
    results.result.forEach(result => {
      result.value.sort((a,b) =>{
        return b.result - a.result;
      })
      .splice(7, 9999);
    });
    const chart = new KeenDataviz({
      container: `.chart-pageviews-by-country-interval-daily`,
      title: 'Views by country',
      type: 'bar',
      legend: {
        position: 'right',
        pagination: {
          limit: 9
        },
        label: {
          textMaxLength: 30
        }
      },
      results,
      sortGroups: 'desc',
      colors: pieColors,
      padding: {
        left: 55,
        top: 0,
        right: 25,
        bottom: 30
      }
    });
});

client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---count-pageviews-by-day-of-week'
  })
  .then(results => {
    const chart = new KeenDataviz({
      container: `.chart-pageviews-by-day-of-week`,
      title: 'Views by day of the week',
      type: 'area',
      labelMapping: {
        1: 'Sun',
        2: 'Mon',
        3: 'Tue',
        4: 'Wed',
        5: 'Thu',
        6: 'Fri',
        7: 'Sat'
      },
      legend: {
        position: 'right',
        pagination: {
          limit: 7
        },
        label: {
          textMaxLength: 30
        }
      },
      colors: pieColors,
      results,
      padding: {
        left: 60,
        top: 0,
        right: 30,
        bottom: 20
      }
    });
});

client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---views-by-hour'
  })
  .then(results => {
    const chart = new KeenDataviz({
      container: `.chart-views-by-hour`,
      title: 'Views by hour',
      type: 'bar',
      legend: {
        position: 'right',
        pagination: {
          limit: 7
        },
        label: {
          textMaxLength: 30
        }
      },
      colors: pieColors,
      results,
      padding: {
        left: 45,
        top: 0,
        right: 20,
        bottom: 20
      },
      axis:{

      }
    });
});



client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---count-views-by-page'
  })
  .then(results => {
    results.result.sort((a,b) =>{
      return b.result - a.result;
    })
    .splice(10, 9999);
    const chart = new KeenDataviz({
      container: `.chart-count-views-by-page`,
      title: 'Top pages by views',
      type: 'pie',
      stacked: true,
    //  sortGroups: 'desc',
      legend: {
        position: 'right',
        pagination: {
          limit: 10
        },
        label: {
          textMaxLength: 30
        }
      },
      colors: pieColors,
      results,
      padding: {
        left: 0,
        top: 0,
        right: 0,
        bottom: 0
      }
    });
});

client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---longest-time-on-page'
  })
  .then(results => {
    results.result.forEach(a =>{
      a.result = (a.result).toFixed(0);
    });
    results.result.sort((a,b) =>{
      return b.result - a.result;
    });
    const chart = new KeenDataviz({
      container: `.chart-longest-time-on-page`,
      title: 'Time on page',
      type: 'table',
      labelMapping: {
        Index: 'Link',
        Result: 'Seconds'
      },
      labelMappingDimension: 'column',
      results
    });
});

client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---percent-of-page-read'
  })
  .then(results => {
    results.result.forEach(a =>{
      a.result = (a.result * 100).toFixed(0);
    });
    results.result.sort((a,b) =>{
      return b.result - a.result;
    });
    const chart = new KeenDataviz({
      container: `.chart-percent-of-page-read`,
      title: 'Pages by scroll depth',
      type: 'table',
      labelMapping: {
        Index: 'Page',
        Result: '%'
      },
      labelMappingDimension: 'column',
      legend: {
        position: 'right',
        pagination: {
          limit: 6
        },
        label: {
          textMaxLength: 30
        }
      },
      colors: pieColors,
      results
    });
});


client
.query({
  saved_query_name: 'autocollector-dashboard-demo---count-pageviews-top-referrers-previous-7-days'
})
    .then(function(results){
      // Handle the result
      results.result.sort((a,b) =>{
        return b.result - a.result;
      })
      .splice(20,9999);
      const chart = new KeenDataviz({
        container: `.chart-pageviews-by-referrer`,
        title: 'Pageviews by referrer',
        type: 'donut',
        labelMapping: {
          Index: 'Domain',
          Result: 'Visitors'
        },
        labelMappingDimension: 'column',
        legend: {
          position: 'left',
          label: {
            textMaxLength: 32
          },
          pagination: {
            limit: 11
          }
        },
        padding:{
          left: 40
        },
        donut: {
          width: 60
        },
        colors: pieColors,

        results
      });

    })
    .catch(function(err){
      // Handle the error

    });


client
    .query({
      saved_query_name: 'autocollector-dashboard-demo---screen-width'
    })
        .then(function(results){
          // Handle the result
          results.result.sort((a,b) =>{
            return b.result - a.result;
          })
          .splice(10,9999);

          const chart = new KeenDataviz({
            container: `.chart-top-pages-screen-width`,
            title: 'Screen resolutions',
            type: 'horizontal-bar',
            results,
            colors: pieColors,
            padding: {
              bottom: 20
            }
          });

        })
        .catch(function(err){
          // Handle the error

        });

client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---pageviews-by-os'
            })
                .then(function(results){
                  // Handle the result
                  results.result.sort((a,b) =>{
                    return b.result - a.result;
                  })
                  .splice(3,9999);

                  const chart = new KeenDataviz({
                    container: `.chart-pageviews-by-os`,
                    title: 'Guests by OS',
                    type: 'bar',
                    results,
                    colors: pieColors,
                    padding: {
                      bottom: 20,
                      right: 30
                    }
                  });

                })
                .catch(function(err){
                  // Handle the error

                });

                // !!! pageviews

                client
                .query({
                  saved_query_name: 'autocollector-dashboard-demo---count-pageviews-previous-7d-interval-daily'
                })
                .then(results => {

                  client
                  .query({
                    saved_query_name: 'autocollector-dashboard-demo---count-pageviews-previous-7d-interval-daily-unique-users'
                  })
                  .then(results2 => {

                  const pageviewsInterval = new KeenDataviz({
                    container: '#chart-views-uniques-7d',
                    title: 'Page views by day',
                    type: 'area',
                    colors: pieColors,
                    results: [results, results2],
                    legend: {
                      position: 'top'
                    },
                    labelMapping: {
                      'pageviews count': 'Views',
                      'pageviews count_unique': 'Uniques'
                    },
                    sortGroups: 'desc',
                    padding: {
                      left: 50,
                      top: 0,
                      right: 35,
                      bottom: 10
                    },

                    point: {
                      r: 0,
                      focus: {
                        expand: {
                          r: 4,
                          enabled: true
                        },
                      },
                      select: {
                        r: 5,
                        enabled: true
                      }
                    },
                    padding: {
                      right: 20,
                      left: 40,
                    },
                  });

                  pageviewsInterval.view._artifacts.c3.select(false, false);

                    });

                });

return;
}


if (activeTab === 'clicks') {


  client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---clicks-by-country-daily'
  })
      .then(function(results){
        // Handle the result
        results.result.forEach(result => {
          result.value.sort((a,b) =>{
            return b.result - a.result;
          })
          .splice(7, 9999);
        });
        const chart = new KeenDataviz({
          container: `.chart-clicks-by-country-daily`,
          title: 'Clicks by Country daily',
          type: 'bar',
          padding:{
            left: 60,
            bottom: 20
          },
          legend: {
            pagination:{
              limit: 12
            },
            label: {
              textMaxLength: 32
            }
          },
          colors: pieColors,
          results,
          sortGroups: 'desc'
        });
        chart.view._artifacts.c3.select(false, false);
      })
      .catch(function(err){
        // Handle the error

      });

  client
      .query({
        saved_query_name: 'autocollector-dashboard-demo---clicks-by-country'
      })
          .then(function(results){
            // Handle the result

            const chart = new KeenDataviz({
              container: `.chart-clicks-by-country`,
              title: 'Overall clicks by Country',
              type: 'pie',
              padding:{
                left: 50,
                bottom: 20
              },
              legend: {
                pagination:{
                  limit: 8
                },
                label: {
                  textMaxLength: 32
                }
              },
              colors: pieColors,
              results,
              sortGroups: 'desc'
            });
          })
          .catch(function(err){
            // Handle the error

          });






          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---outbound-clicks'
            })
            .then(results => {
              results.result.sort((a,b) =>{
                return b.result - a.result;
              })
              .splice(10,9999);
              const chart = new KeenDataviz({
                container: `.chart-outbound-clicks`,
                title: 'Outbound link clicks',
                type: 'table',
                labelMapping: {
                  Index: 'Link',
                  Result: 'Clicks'
                },
                labelMappingDimension: 'column',
                results
              });
          });



          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-by-html-tag'
            })
            .then(results => {
              results.result
              .splice(10,9999);
              const chart = new KeenDataviz({
                container: `.chart-clicks-by-html-tag`,
                title: 'Clicks by HTML tag',
                type: 'donut',
                colors: pieColors,
                results,
                sortGroups: 'desc',
                legend: {
                  pagination: {
                    limit: 18
                  }
                },
                padding:{
                  bottom: 20
                }
              });
          });

          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-by-button-in-org-section'
            })
            .then(results => {
              results.result
              .splice(10,9999);

              results.result.forEach(item => {
                item['element.text'] = item['element.text'].trim();
              });

              results.result = results.result.filter(item => {
                return !!item['element.text'];
              });

              const chart = new KeenDataviz({
                container: `.chart-clicks-by-button-in-org-section`,
                title: 'Clicks by Button in Projects',
                type: 'horizontal-bar',
                results,
                colors: pieColors,
                sortGroups: 'desc',
                padding:{
                  left: 140,
                  bottom: 20
                },
              });
          });

          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-by-button-in-static-section'
            })
            .then(results => {

              results.result.sort((a,b) =>{
                return b.result - a.result;
              })
              .splice(12,9999);

              results.result.forEach(item => {
                item['element.text'] = item['element.text'].trim();
              });

              results.result = results.result.filter(item => {
                return !!item['element.text'];
              });

    const chart = new KeenDataviz({
                container: `.chart-clicks-by-button-in-static-section`,
                title: 'Clicks by Button in Docs',
                type: 'pie',
                colors: pieColors,
                results,
                sortGroups: 'desc',
                padding:{
                  left: 20,
                  bottom: 20
                },
                legend:{
                  pagination: {
                    limit: 22
                  },
                  label:{
                    textMaxLength: 32
                  }
                }
              });
          });



          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-api-docs-sdks'
            })
            .then(results => {

              results.result.sort((a,b) =>{
                return b.result - a.result;
              })
              .splice(12,9999);

              results.result.forEach(item => {
                item['element.text'] = item['element.text'].trim();
              });

              results.result = results.result.filter(item => {
                return !!item['element.text'];
              });

    const chart = new KeenDataviz({
                container: `.chart-clicks-api-docs-sdks`,
                title: 'API SDKs',
                type: 'pie',
                colors: pieColors,
                results,
                sortGroups: 'desc',
                padding:{
                  left: 20,
                  bottom: 20
                },
                legend:{
                  pagination: {
                    limit: 22
                  },
                  label:{
                    textMaxLength: 32
                  }
                }
              });
          });





          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-login-google-github'
            })
            .then(results => {
              results.result.sort((a,b) =>{
                return b.result - a.result;
              })
              .splice(2,9999);

    const chart = new KeenDataviz({
                container: `.chart-clicks-login-google-github`,
                title: 'Sign Up clicks',
                type: 'bar',
                colors: pieColors,
                results,
                sortGroups: 'desc',
                padding:{
                  left: 50,
                  bottom: 20
                },
                legend:{
                  label:{
                    textMaxLength: 32
                  }
                }
              });
          });



          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-api-docs-sdks-by-country'
            })
            .then(results => {

              results.result.sort((a,b) =>{
                return b.result - a.result;
              })
              .splice(6,9999);

    const chart = new KeenDataviz({
                container: `.chart-clicks-api-docs-sdks-by-country`,
                title: 'The most popular SDKs by Country',
                type: 'bar',
                colors: pieColors,
                results,
                sortGroups: 'desc',
                padding:{
                  left: 50,
                  bottom: 20
                },
                legend:{
                  label:{
                    textMaxLength: 32
                  }
                }
              });
          });



          client
            .query({
              saved_query_name: 'autocollector-dashboard-demo---clicks-explorer'
            })
            .then(results => {

       const chart = new KeenDataviz({
                container: `.chart-clicks-explorer`,
                title: 'Clicks in the Keen Explorer',
                type: 'area-step',
                colors: pieColors,
                results,
                sortGroups: 'desc',
                padding:{
                  left: 50,
                  bottom: 20
                },
                legend:{
                  label:{
                    textMaxLength: 32
                  }
                }
              });
          });


}

if (activeTab === 'overview') {
/*

    client
    .query({
      analysis_type: 'count',
      event_collection: 'pageviews',
      timeframe: 'previous_1_months',
      filters: [
        {
          'operator': 'ne',
          'property_name': 'referrer.info.domain',
          'property_value': null
        }],
        group_by: ['url.info.path', 'referrer.info.domain'],
        timezone: window.timezone
      })
      .then(function(res){
        // Handle the result

        pageviewsByPageByReferrer
        .call(function(){
          this.dataset.matrix = parseInto2DArray(res.result, 'referrer.info.domain', 'url.info.path');
        })
        .render();

      })
      .catch(function(err){
        // Handle the error
        pageviewsByPageByReferrer
        .message(err.message);
      });
*/


  areaChartWithDetails({
    client,
    title: 'Views Last 24h',
    container: 'chart-views-last-24h',
    queries: {
      current: 'autocollector-dashboard-demo---count-pageviews-previous-24h',
      compareWith: 'autocollector-dashboard-demo---count-pageviews-previous-48h',
      area: 'autocollector-dashboard-demo---count-pageviews-previous-24h-interval-hourly'
    }
  });

  areaChartWithDetails({
    client,
    title: 'Views Last 7d',
    container: 'chart-views-last-7d',
    queries: {
      current: 'autocollector-dashboard-demo---count-pageviews-previous-7d',
      compareWith: 'autocollector-dashboard-demo---count-pageviews-previous-14d',
      area: 'autocollector-dashboard-demo---count-pageviews-previous-7d-interval-daily'
    }
  });

  areaChartWithDetails({
    client,
    title: 'Clicks Last 24h',
    container: 'chart-clicks-last-24h',
    queries: {
      current: 'autocollector-dashboard-demo---count-clicks-previous-24h',
      compareWith: 'autocollector-dashboard-demo---count-clicks-previous-48h',
      area: 'autocollector-dashboard-demo---count-clicks-previous-24h-interval-hourly'
    }
  });

  areaChartWithDetails({
    client,
    title: 'Clicks Last 7d',
    container: 'chart-clicks-last-7d',
    queries: {
      current: 'autocollector-dashboard-demo---count-clicks-previous-7d',
      compareWith: 'autocollector-dashboard-demo---count-clicks-previous-14d',
      area: 'autocollector-dashboard-demo---count-clicks-previous-7d-interval-daily'
    }
  });

  client
  .query({
    saved_query_name: 'autocollector-dashboard-demo---count-pageviews-by-city'
  })
  .then(res => {

    const citiesFromResult = res.result;
    citiesFromResult.forEach(cityFromResult => {
      let cityInCoordinatesArray =
      coordinates.find(item => item.fields.city.toLowerCase() === cityFromResult['geo.city'].toLowerCase());
      if (cityInCoordinatesArray) {
        cityFromResult.coordinates = cityInCoordinatesArray.geometry.coordinates;
      }
    });
    const citiesWithCoordinates = citiesFromResult.filter(city => !!city.coordinates);

    let activeMapData;
    const appMapAreaNode = document.getElementById('map');

    function init(){
      window.mapInited = true;
      L.mapbox.accessToken = 'pk.eyJ1Ijoia2Vlbi1pbyIsImEiOiIza0xnNXBZIn0.PgzKlxBmYkOq6jBGErpqOg';
      const map = L.mapbox.map('map', 'keen-io.kae20cg0', {
        attributionControl: true,
        center: [ 35.77350, -98.41104 ],
        zoom: 5
      });
      activeMapData = L.layerGroup().addTo(map);
      activeMapData.clearLayers();

      citiesWithCoordinates.forEach((city, index) => {
        let size = 'small';
        if (city.result > 3) {
          size = 'medium';
        }
        if (city.result > 7) {
          size = 'large';
        }
        var em = L.marker(new L.LatLng(city.coordinates[1], city.coordinates[0]), {
          icon: L.mapbox.marker.icon({
            'marker-color': {
                small: pieColors[0],
                medium: pieColors[1],
                large: pieColors[2]
              }[size],
            'marker-size':  size,
            'marker-symbol': city.result
          })
        }).addTo(activeMapData);;
      });
    /*
      icon: L.icon({
      'marker-color': '#00bbde',
      iconUrl: './img/large.png',
      iconRetinaUrl: './img/large.png',
      iconSize: [size, size]
    })
    */
  }

  if (!window.mapInited) {
    init();
  }

});

client
.query({
  saved_query_name: 'autocollector-dashboard-demo---count-pageviews-top-referrers-previous-7-days-interval-daily'
})
.then(results => {
  new KeenDataviz({
    container: '.chart-top-referrers',
    title: 'Views By Top 3 Sources',
    type: 'area-spline',
    colors: pieColors,
    results,
    legend: {
      position: 'top'
    },
    labelMapping: {
      'fbads': 'Facebook',
      'adwords': 'Google',
      'sendgrid_docs': 'Sendgrid'
    },
    sortGroups: 'desc',
    padding: {
      left: 50,
      top: 0,
      right: 35,
      bottom: 0
    }
  });
});



client
.query({
  saved_query_name: 'autocollector-dashboard-demo---count-pageviews-by-browser-family'
})
.then(results => {

const revenuexChart = new KeenDataviz({
  container: '.chart-user-agents',
  title: 'User agents',
  type: 'pie',
  colors: pieColors,
  results,
  sortGroups: 'desc',
  legend: {
    pagination: {
      limit: 4
    }
  },
  size: {
    width: 320
  }
});
});


const metricBox = ({ title, value, container, icon }) => {
  const element = document.getElementById(container);
  element.innerHTML = `
  <i class='fas fa-${icon}'></i>
  <div class='label'>
    <div class='value'>${value}</div>
    <div class='title'>${title}</div>
  </div>
  `;
};

client
.query({
  saved_query_name: 'autocollector-dashboard-demo---unique-users-this-7d'
})
.then(results => {
  metricBox({
    title: 'Unique Visitors',
    icon: 'users',
    value: results.result,
    container: 'unique-users-this-7d'
  });
});

client
.query({
  saved_query_name: 'autocollector-dashboard-demo---average-time-on-page'
})
.then(results => {
  metricBox({
    title: 'Avg Time on Site',
    icon: 'clock',
    value: results.result.toFixed(0) + ' seconds',
    container: 'average-time-on-page'
  });
});

client
.query({
  saved_query_name: 'autocollector-dashboard-demo---average-clicks-per-user'
})
.then(results => {
  const clicksPerUser = Math.floor(
    results.result.reduce((acc = 0, item) => {
      return (acc.result || acc || 0) + parseInt(item.result);
    }) / results.result.length
  );
  metricBox({
    title: 'Avg Clicks per User',
    icon: 'hand-pointer',
    value: clicksPerUser,
    container: 'average-clicks-per-user'
  });
});

client
.query({
  saved_query_name: 'autocollector-dashboard-demo---average-scroll-ratio'
})
.then(results => {
  metricBox({
    title: 'Avg Page Read',
    icon: 'percent',
    value: results.result.toFixed(2) * 100,
    container: 'average-scroll-ratio'
  });
});

// autocollector-dashboard-demo---unique-users-this-7d
// autocollector-dashboard-demo---average-time-on-page
// autocollector-dashboard-demo---average-clicks-per-user
// autocollector-dashboard-demo---average-scroll-ratio

return;

}

}

switchTab('overview');

// autocollector-dashboard-demo---count-pageviews-top-referrers-previous-7-days-interval-daily

// autocollector-dashboard-demo---unique-users-this-7d
// autocollector-dashboard-demo---average-time-on-page
// autocollector-dashboard-demo---average-clicks-per-user
// autocollector-dashboard-demo---average-scroll-ratio

/*
const revenuexChart = new KeenDataviz({
  container: '.x-chart',
  title: 'Conversion rate',
  type: 'donut',
  point: {
  },
  colors: [pieColors[0], '#fafafa'],
  padding: {
  },
  legend: { show: false },
  //  label: { show: false },
  tooltip: {
    show: false
  },
  donut: {
    width: 12,
    label: {

      format: function (value, ratio, id) {
        //    return d3.format('$')(value);
        return value + '%';
      }
      //  show: false
    }
  },
  results: {result: [{x:1, result: 66}, {x:2, result:34}]}
});



const revenuexChart2 = new KeenDataviz({
  container: '.x-chart2',
  title: 'Total orders',
  type: 'donut',
  point: {
  },
  colors: [pieColors[1], '#fafafa'],
  padding: {
  },
  legend: { show: false },
  //  label: { show: false },
  tooltip: {
    show: false
  },
  donut: {
    width: 12,
    label: {

      format: function (value, ratio, id) {
        //    return d3.format('$')(value);
        return '$' + value;
      }
      //  show: false
    }
  },
  results: {result: [{x:1, result: 1260}, {x:2, result:300}]}
});


new KeenDataviz({
  container: '.x-chart3',
  title: 'Traffic New vs Returning',
  type: 'bar',
  point: {
  },
  colors: barColors,
  padding: {
  },
  //  label: { show: false },
  donut: {
    width: 12
  },
  results: {result: [{x:'New', result: 360}, {x:'Returning', result:700}]}
});

new KeenDataviz({
  container: '.x-chart4',
  title: 'Revenue New vs Recurring',
  type: 'donut',
  point: {
  },
  colors: triadicColors,
  padding: {
  },
  //  label: { show: false },

  donut: {
    width: 20,
    label: {
      format: function (value, ratio, id) {
        //    return d3.format('$')(value);
        return  id + ' ' + value + '%';
      }
    },
  },
  results: {result: [{x:'New', result: 1360}, {x:'Recurring', result:300}]}
});




new KeenDataviz({
  container: '.x-chart5',
  title: 'Traffic Direct vs Referrals',
  type: 'donut',
  point: {
  },
  colors: pieColors,
  padding: {
  },
  legend:{
    position: 'bottom'
  },
  //  label: { show: false },
  donut: {
    width: 20
  },
  results: {result: [{x:'Direct', result: 160}, {x:'Referrals', result:220}]}
});

const revenueChart = new KeenDataviz({
  container: '.revenue-chart',
  title: 'Reveune this month',
  type: 'area-spline',
  point: {
    r: 0,
    focus: {
      expand: {
        r: 5,
        enabled: true
      },
    },
    select: {
      r: 5,
      enabled: true
    }
  },

  axis: {
    y: {
      show: false
    },
    x: {
      show:false
    }
  },

  grid:{
    x: {
      show: false
    },
    y: {
      show: false
    }

  },

  colors: triadicColors,
  padding: {
    left: -25,
    right: -25
  },
});
revenueChart.call(function(){
  const dataset = [['Index', 'Result']];
  let sum = 21422;
  for(let i=1;i<13;i++){
    sum = Math.round(30000 * Math.random() );
    dataset.push([i, sum]);
  }
  this.dataset.matrix = dataset;
})
.render();

// document.getElementById("timeframe").innerHTML="timeframe: " + timeframe.replace(/_/g, ' ');

// https://github.com/keen/keen-analysis.js
const queryPageviews = client
.query({
  analysis_type: 'count',
  event_collection: 'pageviews',
  timeframe,
  interval: 'daily',
  timezone: window.timezone
});

const queryClicks = client
.query({
  analysis_type: 'count',
  event_collection: 'clicks',
  timeframe,
  interval: 'daily',
  timezone: window.timezone
});

client
.run([queryPageviews, queryClicks])
.then(function(results){
  // Handle the result
  // https://github.com/keen/keen-dataviz.js

  const pageviewsInterval = new KeenDataviz({
    container: '.pageviews-interval',
    title: 'Page Views By Day',
    type: 'line',
    results,
    labelMapping: {
      'pageviews count': 'Pageviews',
      'clicks count': 'Clicks'
    },
    legend: {
      position: 'bottom'
    },
    point: {
      r: 0,
      focus: {
        expand: {
          r: 3,
          enabled: true
        },
      },
      select: {
        r: 4,
        enabled: true
      }
    },
    colors: triadicColors,
    padding: {
      right: 20,
      left: 40,
    },
  });

  pageviewsInterval.view._artifacts.c3.select(false, false);

})
.catch(function(err){
  // Handle the error
  pageviews
  .message(err.message);
});

const pageviewsByReferrer = new KeenDataviz({
  container: '.pageviews-by-referrer',
  type: 'horizontal-bar',
  title: 'Top 10 Referral Sources',
  sortGroups: 'desc',
  colors: triadicColors
});

client
.query({
  analysis_type: 'count',
  event_collection: 'pageviews',
  timeframe: 'previous_1_months',
  filters: [
    {
      'operator': 'ne',
      'property_name': 'referrer.info.domain',
      'property_value': null
    }],
    group_by: [
      'referrer.info.domain'],
      timezone: window.timezone
    })
    .then(function(res){
      // Handle the result
      pageviewsByReferrer
      .render(res);
    })
    .catch(function(err){
      // Handle the error
      pageviewsByReferrer
      .message(err.message);
    });

    client
    .query({
      analysis_type: 'count',
      event_collection: 'pageviews',
      timeframe: 'previous_1_months',
      filters: [
        {
          'operator': 'ne',
          'property_name': 'referrer.info.domain',
          'property_value': null
        }],
        group_by: ['url.info.path', 'referrer.info.domain'],
        timezone: window.timezone
      })
      .then(function(res){
        // Handle the result

        pageviewsByPageByReferrer
        .call(function(){
          this.dataset.matrix = parseInto2DArray(res.result, 'referrer.info.domain', 'url.info.path');
        })
        .render();

      })
      .catch(function(err){
        // Handle the error
        pageviewsByPageByReferrer
        .message(err.message);
      });
      const pageviewsByPageByReferrer = new KeenDataviz({
        container: '.top-5-w-referral',
        type: 'bar',
        stacked: true,
        title: 'Top 5 Pages /w referral source',
        sortGroups: 'desc',
        colors: barColors,
        legend: {
          position: 'bottom',
        }
      });

      const top5avgTime = new KeenDataviz({
        container: '.top-5-avg-time',
        type: 'pie',
        title: 'Top 5 Pages Avg Time One Page',
        colors: pieColors,
        sortGroups: 'desc',
      });

      client
      .query({
        analysis_type: 'average',
        target_property: 'time.local.hour',
        event_collection: 'pageviews',
        group_by: 'geo.country',
        timeframe: timeframe,
        timezone: window.timezone
      })
      .then(function(res){
        // Handle the result
        top5avgTime
        .render(res);
      })
      .catch(function(err){
        // Handle the error
        top5avgTime
        .message(err.message);
      });


      const viewsByPage = new KeenDataviz({
        container: '.views-by-page',
        type: 'table',
        title: 'Views By Page',
        labelMapping: {
          Index: 'Page',
          Result: 'Views'
        },
        labelMappingDimension: 'both',
        sortGroups: 'desc',
      });

      client
      .query({
        analysis_type: 'count',
        event_collection: 'pageviews',
        timeframe: 'previous_1_months',
        group_by: ['url.info.path'],
        timezone: window.timezone
      })
      .then(function(res){
        // Handle the result
        viewsByPage
        .render(res);
      })
      .catch(function(err){
        // Handle the error
        viewsByPage
        .message(err.message);
      });


      /*
      const uniquePageviews = new KeenDataviz({
      container: '.unique-pageviews',
      type: 'metric',
      title: 'Unique Pageviews'
    });

    client
    .query({
    analysis_type: 'count_unique',
    event_collection: 'pageviews',
    target_property: 'user.uuid',
    timeframe: timeframe,
    timezone: window.timezone
  })
  .then(function(res){
  // Handle the result
  uniquePageviews
  .render(res);
})
.catch(function(err){
// Handle the error
uniquePageviews
.message(err.message);
});

const pageviewsByDay = new KeenDataviz({
  container: '.pageviews-by-day',
  type: 'bar',
  title: 'Views by Day of the Week',
  labelMapping: {
    '1': 'Sunday',
    '2': 'Monday',
    '3': 'Tuesday',
    '4': 'Wednesday',
    '5': 'Thursday',
    '6': 'Friday',
    '7': 'Saturday'
  },
  labelMappingDimension: 'row'
});

client
.query({
  analysis_type: 'count',
  event_collection: 'pageviews',
  group_by: [
    'time.local.day_of_week'
  ],
  timeframe,
  timezone: window.timezone
})
.then(function(res){
  // Handle the result
  pageviewsByDay
  .render(res);

})
.catch(function(err){
  // Handle the error
  pageviewsByDay
  .message(err.message);
});

const pageviewsByBrowser = new KeenDataviz({
  container: '.pageviews-by-browser',
  type: 'donut',
  title: 'Pageviews by Browser',
  colors: pieColors
});

client
.query('count', {
  event_collection: 'pageviews',
  group_by: [
    'tech.browser.family'
  ],
  filters: [{
    property_name: 'tech.browser.family',
    operator: 'ne',
    property_value: 'Other'
  },
  {
    property_name: 'tech.browser.family',
    operator: 'ne',
    property_value: 'Googlebot'
  }],
  timeframe,
  timezone
})
.then(function(res){
  // Handle the result
  pageviewsByBrowser
  .render(res);
})
.catch(function(err){
  // Handle the error
  pageviewsByBrowser
  .message(err.message);
});


const pageviewsByMobile = new KeenDataviz({
  container: '.pageviews-by-mobile',
  type: 'donut',
  title: 'Bounce rate',
  colors: pieColors,
  legend: false,

});

client
.query('count', {
  event_collection: 'pageviews',
  filters: [{
    property_name: 'tech.browser.family',
    operator: 'contains',
    property_value: 'Mobile'
  },
  {
    property_name: 'tech.browser.family',
    operator: 'ne',
    property_value: 'Googlebot'
  }],
  timeframe,
  timezone
})
.then(function(res){
  // Handle the result

  client
  .query('count', {
    event_collection: 'pageviews',
    filters: [{
      property_name: 'tech.browser.family',
      operator: 'not_contains',
      property_value: 'Mobile'
    },
    {
      property_name: 'tech.browser.family',
      operator: 'ne',
      property_value: 'Googlebot'
    }],
    timeframe,
    timezone
  })
  .then(function(res2){
    pageviewsByMobile.call(function(){
      const dataset = [['Index', 'Result']];
      dataset.push(['Desktop', res2.result]);
      dataset.push(['Mobile', res.result]);
      this.dataset.matrix = dataset;
    })
    .render();
  });

})
.catch(function(err){
  // Handle the error
  pageviewsByMobile
  .message(err.message);
});

const popularPages = new KeenDataviz({
  container: '.popular-pages-visited',
  title: 'Page views by title',
  type: 'bar',
  stacked: true,
  colors: barColors,
  legend:{
    position: 'top'
  }
});

client
.query({
  analysis_type: 'count',
  event_collection: 'pageviews',
  group_by: [
    'page.title'
  ],
  timeframe,
  interval: 'daily',
  timezone
})
.then(function(res){
  // Handle the result
  popularPages
  .render(res);
})
.catch(function(err){
  // Handle the error
  popularPages
  .message(err.message);
});

const pageviewsByCountry = new KeenDataviz({
  container: '.pageviews-by-country',
  type: 'horizontal-bar',
  title: 'Pageviews by Country',
  sortGroups: 'desc',
  colors: triadicColors
});

client
.query({
  analysis_type: 'count',
  event_collection: 'pageviews',
  group_by: [
    'geo.country'
  ],
  timeframe,
  timezone
})
.then(function(res){
  // Handle the result
  pageviewsByCountry
  .render(res);
})
.catch(function(err){
  // Handle the error
  pageviewsByCountry
  .message(err.message);
});

const pageviewsByCity = new KeenDataviz({
  container: '.pageviews-by-city',
  type: 'table',
  title: 'Pageviews by City',
  sortGroups: 'desc'
});

client
.query({
  analysis_type: 'count',
  event_collection: 'pageviews',
  group_by: [
    'geo.city'
  ],
  timeframe,
  timezone
})
.then(function(res){
  // Handle the result
  pageviewsByCity
  .render(res);
})
.catch(function(err){
  // Handle the error
  pageviewsByCity
  .message(err.message);
});

*/
}
</script>
</body>
</html>
